name: ARMOR Checkers Reusable Workflow

on:
  workflow_call:
    inputs:
      base-sha:
        required: false
        type: string
        default: ''
      head-sha:
        required: false
        type: string
        default: ''
      branch-name:
        required: false
        type: string
        default: ''
      build-script:
        required: false
        type: string
        default: 'ci/build.sh'
        description: 'Build script path used by ABI checker'

permissions:
  contents: read

jobs:
  prepare:
    name: Setup ARMOR checkers event variables
    runs-on: ubuntu-latest
    outputs:
      event_name:  ${{ steps.ev.outputs.event_name }}
      head_sha:    ${{ steps.ev.outputs.head_sha }}
      base_sha:    ${{ steps.ev.outputs.base_sha }}
      branch_name: ${{ steps.ev.outputs.branch_name }}
      ref:         ${{ steps.ev.outputs.ref }}
      repo:        ${{ steps.ev.outputs.repo }}
      build_script: ${{ steps.ev.outputs.build_script }}
    steps:
      - name: Set event variables
        id: ev
        shell: bash
        run: |
          set -euo pipefail

          echo "event_name=${{ github.event_name }}" >> "$GITHUB_OUTPUT"
          echo "ref=${{ github.ref }}" >> "$GITHUB_OUTPUT"
          echo "repo=${{ github.repository }}" >> "$GITHUB_OUTPUT"
          echo "build_script=${{ inputs.build-script }}" >> "$GITHUB_OUTPUT"

          if [[ "${{ github.event_name }}" == "pull_request" || "${{ github.event_name }}" == "pull_request_target" ]]; then
            echo "head_sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            echo "base_sha=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
            echo "branch_name=${{ github.event.pull_request.base.ref }}" >> "$GITHUB_OUTPUT"

          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "head_sha=${{ inputs.head-sha }}" >> "$GITHUB_OUTPUT"
            echo "base_sha=${{ inputs.base-sha }}" >> "$GITHUB_OUTPUT"
            echo "branch_name=${{ inputs.branch-name }}" >> "$GITHUB_OUTPUT"

          else
            echo "head_sha=${{ github.event.after }}" >> "$GITHUB_OUTPUT"
            echo "base_sha=${{ github.event.before }}" >> "$GITHUB_OUTPUT"
            echo "branch_name=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi

  armor-api-check:
    name: Run ARMOR API Check
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Run ARMOR Tool
        uses: qualcomm-linux-stg/armor@abi_checks
        with:
          event-name:  ${{ needs.prepare.outputs.event_name }}
          head-sha:    ${{ needs.prepare.outputs.head_sha }}
          base-sha:    ${{ needs.prepare.outputs.base_sha }}
          ref:         ${{ needs.prepare.outputs.ref }}
          repo:        ${{ needs.prepare.outputs.repo }}
          branch-name: ${{ needs.prepare.outputs.branch_name }}

  abi-check:
    name: Run ABI Check
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Paths filter (only run ABI on code changes)
        id: cf
        uses: dorny/paths-filter@v3
        with:
          base: ${{ needs.prepare.outputs.base_sha }}
          ref:  ${{ needs.prepare.outputs.head_sha }}
          filters: |
            code:
              - '**/*.h'
              - '**/*.hpp'
              - '**/*.c'
              - '**/*.cpp'

      - name: Stop early if no code changes
        if: ${{ steps.cf.outputs.code != 'true' }}
        shell: bash
        run: |
          echo "No *.h/*.hpp/*.c/*.cpp changes detected; skipping ABI check."
          echo "No code file changes detected between base and head. Skipping ABI checks." >> "$GITHUB_STEP_SUMMARY"
          exit 0

      - name: Run ABI checks
        if: ${{ steps.cf.outputs.code == 'true' }}
        uses: qualcomm-linux-stg/armor/abi_checks@abi_checks
        with:
          event-name:   ${{ needs.prepare.outputs.event_name }}
          head-sha:     ${{ needs.prepare.outputs.head_sha }}
          base-sha:     ${{ needs.prepare.outputs.base_sha }}
          ref:          ${{ needs.prepare.outputs.ref }}
          repo:         ${{ needs.prepare.outputs.repo }}
          branch-name:  ${{ needs.prepare.outputs.branch_name }}
          build-script: ${{ needs.prepare.outputs.build_script }}